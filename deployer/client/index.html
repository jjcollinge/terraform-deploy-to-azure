<!doctype html>
<!-- 
// Notes:
// Ordering = Encrypt then MAC https://crypto.stackexchange.com/questions/202/should-we-mac-then-encrypt-or-encrypt-then-mac
// Keys = HDKF from shared secert https://security.stackexchange.com/questions/37880/why-cant-i-use-the-same-key-for-encryption-and-mac 
-->


<!--  https://github.com/beatgammit/base64-js -->
<script src="base64js.min.js"></script>

<head>
    <!-- Xterm import-->
    <link rel="stylesheet" href="node_modules/xterm/dist/xterm.css" />
    <script src="node_modules/xterm/dist/xterm.js"></script>
    <script src="node_modules/xterm/dist/addons/fit/fit.js"></script>

    <!-- AzureSDK Import -->
    <script src="node_modules/ms-rest-js/dist/msRest.browser.js"></script>
    <script src="node_modules/ms-rest-azure-js/dist/msRestAzure.js"></script>
    <script src="node_modules/ms-rest-browserauth/dist/msAuth.js"></script>
    <script src="azure-containerinstance/dist/arm-containerinstance.js"></script>
    <script src="creds.private.js"></script>

    <script type="text/javascript">
        var ws = "";


        createACIInstance(token, subscriptionId,
            "temp-deployazure", "test1",
            "https://github.com/jjcollinge/tfexample",
            "706e0ec1efbed9e87223a4c93e2ba698a4f30aaa", "").then(x => {

            });


        async function createACIInstance(token, subscriptionId, resourceGroup, containerGroupName, repoUrl, repoCommitHash, repoDir) {
            const creds = new msRest.TokenCredentials(token);
            const client = new Azure.ArmContainerinstance.ContainerInstanceManagementClient(creds, subscriptionId);

            let containerGroupCreated = await client.containerGroups.createOrUpdate(resourceGroup, containerGroupName, {
                location: "eastus",
                osType: "linux",
                volumes: [
                    {
                        name: "gitrepo",
                        gitRepo: {
                            repository: repoUrl,
                            revision: repoCommitHash,
                            directory: repoDir,
                        }
                    }
                ],
                containers: [
                    {
                        name: "terraform-deployer",
                        image: "lawrencegripper/tfdeployer",
                        port: [
                            {
                                port: 3012,
                            },
                        ],
                        environmentVariables: [
                            {
                                name: "AES_KEY",
                                secureValue: ""
                            },
                            {
                                name: "HMAC_KEY",
                                secureValue: ""
                            }
                        ],
                        volumeMounts: [
                            {
                                name: "gitrepo",
                                mountPath: "/git"
                            }
                        ],
                        resources: {
                            requests: {
                                memoryInGB: 1,
                                cpu: 1,
                            }
                        }
                    }],
            })

            while (true) {
                let existing = await client.containerGroups.get(resourceGroup, containerGroupName);
                console.log(existing);
                if (existing.ipAddress != null) {
                    return existing.ipAddress;
                }

            }
        }

        function connect(address) {
            ws = new WebSocket("ws://"+address+":80/service")

            ws.onopen = function () {
                console.log("connected")
            };

            ws.onmessage = function (evt) {
                term.writeln(evt.data)
                // var received_msg = evt.data;
            };
            ws.onclose = function () {
                console.log("Connection is closed...");
            };
        };
        function accept() {
            ws.send("yes\n");
        }



    </script>
</head>

<body style="font-size:x-large">
    <div>
        <a href="#" onclick="connect();">Click here to start</a></div>
    <a href="#" onclick="accept();">Accept</a></div>
    <div id="terminal"></div>
    <script>
        Terminal.applyAddon(fit);

        var term = new Terminal();
        term.open(document.getElementById('terminal'));
        term.write('Welcome to \x1B[1;3;31mTerraform Deploy to Azure\x1B[0m $ ')
        term.fit();  
    </script>
</body>

</html>