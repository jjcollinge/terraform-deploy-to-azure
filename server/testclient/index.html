<!doctype html>
<!-- 
// Notes:
// Ordering = Encrypt then MAC https://crypto.stackexchange.com/questions/202/should-we-mac-then-encrypt-or-encrypt-then-mac
// Keys = HDKF from shared secert https://security.stackexchange.com/questions/37880/why-cant-i-use-the-same-key-for-encryption-and-mac 
-->


<!--  https://github.com/beatgammit/base64-js -->
<script src="base64js.min.js"></script>

<head>
    <!-- Xterm import-->
    <link rel="stylesheet" href="node_modules/xterm/dist/xterm.css" />
    <script src="../node_modules/xterm/dist/addons/fit/fit.js"></script>
    <script src="../node_modules/xterm/dist/addons/attach/attach.js"></script>
    <script src="../node_modules/xterm/dist/xterm.js"></script>
    <script src="crypto.js"></script>
    <script src="base64js.min.js"></script>

   
</head>

<body>
    <div id="terminal"></div>
    <script>
        Terminal.applyAddon(fit);
        Terminal.applyAddon(attach);

        var term = new Terminal();
        term.open(document.getElementById('terminal'));
        term.writeln("");
        term.writeln('Welcome to \x1B[1;3;31mTerraform Deploy to Azure\x1B[0m $ ')
        term.fit();
        ws = new WebSocket("ws://localhost:3013/terminal")

        // Wrapper to handle encryption. 
        let wsWrapper = {
            original: ws,
            addEventListener: function(type, handler) {
                if (type === "message") {
                    return ws.addEventListener(type, (evt) => {
                        console.log("received:" + evt.data)
                        return handler(evt);
                    });
                }
                return ws.addEventListener(type, handler);
            },
            send: function(data) {
                console.log("sending" + data);
                return ws.send(data);
            },
            readyState: 1,
        }


        ws.onopen = function() {
            console.log("connected")
            console.log(term)
            term.attach(wsWrapper);
        }
    </script>
</body>

</html>